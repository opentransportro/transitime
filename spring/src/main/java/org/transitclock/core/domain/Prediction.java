/* (C)2023 */
package org.transitclock.core.domain;

import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;
import org.transitclock.applications.Core;
import org.transitclock.ipc.data.IpcPrediction;

import java.io.Serializable;
import java.util.Date;

@Data
@Document(collection = "Predictions")
public class Prediction implements Serializable {

    // Need an ID but using a regular column doesn't really make
    // sense. So use an auto generated one. Not final since
    // autogenerated and therefore not set in constructor.
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private long id;

    // The revision of the configuration data that was being used
    private final int configRev;

    private final Date predictionTime;

    // Timestamp of the AVL report that caused the prediction to be generated
    private final Date avlTime;

    // The time the AVL data was processed and the prediction was created.
    @Indexed(name = "PredictionTimeIndex")
    private final Date creationTime;

    private final String vehicleId;

    private final String stopId;

    private final String tripId;

    private final String routeId;

    private final boolean affectedByWaitStop;

    private final boolean isArrival;

    private final boolean schedBasedPred;

    private final int gtfsStopSeq;

    public Prediction(
            long predictionTime,
            long avlTime,
            long creationTime,
            String vehicleId,
            String stopId,
            String tripId,
            String routeId,
            boolean affectedByWaitStop,
            boolean isArrival,
            boolean schedBasedPred,
            int gtfsStopSeq) {
        this.configRev = Core.getInstance().getDbConfig().getConfigRev();
        this.predictionTime = new Date(predictionTime);
        this.avlTime = new Date(avlTime);
        this.creationTime = new Date(creationTime);
        this.vehicleId = vehicleId;
        this.stopId = stopId;
        this.tripId = tripId;
        this.routeId = routeId;
        this.affectedByWaitStop = affectedByWaitStop;
        this.isArrival = isArrival;
        this.schedBasedPred = schedBasedPred;
        this.gtfsStopSeq = gtfsStopSeq;
    }

    public Prediction(IpcPrediction prediction) {
        this.configRev = Core.getInstance().getDbConfig().getConfigRev();
        this.predictionTime = new Date(prediction.getPredictionTime());
        this.avlTime = new Date(prediction.getAvlTime());
        this.creationTime = new Date(prediction.getCreationTime());
        this.vehicleId = prediction.getVehicleId();
        this.stopId = prediction.getStopId();
        this.tripId = prediction.getTripId();
        this.routeId = prediction.getTrip().getRouteId();
        this.affectedByWaitStop = prediction.isAffectedByWaitStop();
        this.isArrival = prediction.isArrival();
        this.schedBasedPred = prediction.isSchedBasedPred();
        this.gtfsStopSeq = prediction.getGtfsStopSeq();
    }
}
